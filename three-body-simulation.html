<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰ä½“è¿åŠ¨æ¨¡æ‹Ÿ - Three-Body Problem Simulation</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: #000;
            color: #fff;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            overflow: hidden;
            display: flex;
        }

        #canvas-container {
            flex: 1;
            position: relative;
        }

        canvas {
            display: block;
            background: radial-gradient(ellipse at center, #0a0a1a 0%, #000 100%);
        }

        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.5;
        }

        #sidebar {
            width: 450px;
            min-width: 300px;
            max-width: 800px;
            background: linear-gradient(180deg, #0a0a15 0%, #050508 100%);
            border-left: 1px solid #1a1a2e;
            padding: 20px;
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow-y: auto;
            position: relative;
        }

        #resize-handle {
            position: absolute;
            left: 0;
            top: 0;
            width: 6px;
            height: 100%;
            background: transparent;
            cursor: ew-resize;
            z-index: 100;
            transition: background 0.2s;
        }

        #resize-handle:hover,
        #resize-handle.dragging {
            background: linear-gradient(180deg, #ff6b6b, #feca57, #48dbfb);
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #ff6b6b, #feca57, #48dbfb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 20px;
        }

        .panel {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .panel-title {
            font-size: 0.9rem;
            color: #888;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title::before {
            content: '';
            width: 3px;
            height: 14px;
            background: linear-gradient(180deg, #ff6b6b, #feca57);
            border-radius: 2px;
        }

        .civilization-number {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            background: linear-gradient(90deg, #ff6b6b, #feca57);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .civilization-label {
            text-align: center;
            color: #666;
            font-size: 0.85rem;
        }

        .status {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .status:last-child {
            border-bottom: none;
        }

        .status-label {
            color: #888;
            font-size: 0.85rem;
        }

        .status-value {
            font-family: 'Consolas', monospace;
            color: #48dbfb;
        }

        .status-value.danger {
            color: #ff6b6b;
            animation: pulse 1s ease-in-out infinite;
        }

        .status-value.safe {
            color: #1dd1a1;
        }

        .status-value.warning {
            color: #feca57;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        button {
            flex: 1;
            min-width: 60px;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
        }

        .btn-reset {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }

        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 107, 107, 0.4);
        }

        .btn-speed {
            background: linear-gradient(135deg, #48dbfb, #0abde3);
            color: white;
        }

        .btn-speed:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(72, 219, 251, 0.4);
        }

        .btn-pause {
            background: linear-gradient(135deg, #feca57, #ff9f43);
            color: white;
        }

        .btn-pause:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(254, 202, 87, 0.4);
        }

        .speed-control {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .speed-control input[type="range"] {
            flex: 1;
            -webkit-appearance: none;
            height: 6px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            outline: none;
        }

        .speed-control input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: linear-gradient(135deg, #48dbfb, #0abde3);
            border-radius: 50%;
            cursor: pointer;
        }

        .speed-display {
            text-align: center;
            padding: 10px;
            background: rgba(72, 219, 251, 0.1);
            border-radius: 8px;
            margin-top: 10px;
            font-family: 'Consolas', monospace;
        }

        .history-list {
            flex: 1;
            overflow-y: auto;
            max-height: 200px;
        }

        .history-item {
            padding: 10px;
            margin-bottom: 8px;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            border-left: 3px solid;
            font-size: 0.85rem;
        }

        .history-item.long {
            border-color: #1dd1a1;
        }

        .history-item.medium {
            border-color: #feca57;
        }

        .history-item.short {
            border-color: #ff6b6b;
        }

        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-civ {
            font-weight: bold;
            color: #fff;
        }

        .history-time {
            color: #888;
            font-family: 'Consolas', monospace;
        }

        .history-cause {
            font-size: 0.75rem;
            color: #666;
            margin-top: 5px;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #888;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            background: rgba(255, 107, 107, 0.9);
            color: white;
            border-radius: 10px;
            font-size: 1.1rem;
            opacity: 0;
            transition: opacity 0.5s ease;
            pointer-events: none;
            z-index: 1000;
        }

        .notification.show {
            opacity: 1;
        }

        .temp-bar {
            width: 100%;
            height: 20px;
            background: linear-gradient(90deg,
                #0066ff 0%,
                #00ffff 15%,
                #00ff00 30%,
                #ffff00 50%,
                #ff9900 70%,
                #ff0000 85%,
                #ff00ff 100%
            );
            border-radius: 10px;
            position: relative;
            margin: 10px 0;
        }

        .temp-indicator {
            position: absolute;
            top: -5px;
            width: 4px;
            height: 30px;
            background: white;
            border-radius: 2px;
            transform: translateX(-50%);
            box-shadow: 0 0 10px rgba(255,255,255,0.8);
            transition: left 0.3s ease;
        }

        .temp-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #666;
        }

        .survival-zone {
            position: absolute;
            top: 0;
            height: 100%;
            background: rgba(0,255,0,0.3);
            border: 1px solid #00ff00;
            border-radius: 3px;
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.3);
        }

        .info-box {
            font-size: 0.75rem;
            color: #666;
            background: rgba(255,255,255,0.02);
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
        }

        .trail-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .trail-toggle label {
            color: #888;
            font-size: 0.85rem;
        }

        .trail-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .view-hint {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.7);
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 0.8rem;
            color: #888;
            pointer-events: none;
        }

        .leaderboard {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 220px;
        }

        .leaderboard-title {
            font-size: 0.9rem;
            color: #feca57;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .leaderboard-title::before {
            content: 'ğŸ†';
        }

        .leaderboard-list {
            list-style: none;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            font-size: 0.8rem;
        }

        .leaderboard-item:last-child {
            border-bottom: none;
        }

        .leaderboard-rank {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.75rem;
            margin-right: 10px;
        }

        .leaderboard-rank.gold {
            background: linear-gradient(135deg, #feca57, #ff9f43);
            color: #000;
        }

        .leaderboard-rank.silver {
            background: linear-gradient(135deg, #dfe6e9, #b2bec3);
            color: #000;
        }

        .leaderboard-rank.bronze {
            background: linear-gradient(135deg, #e17055, #d63031);
            color: #fff;
        }

        .leaderboard-rank.normal {
            background: rgba(255,255,255,0.1);
            color: #888;
        }

        .leaderboard-civ {
            flex: 1;
            color: #fff;
        }

        .leaderboard-duration {
            color: #1dd1a1;
            font-family: 'Consolas', monospace;
            font-size: 0.75rem;
        }

        .leaderboard-empty {
            color: #666;
            font-size: 0.8rem;
            text-align: center;
            padding: 10px 0;
        }

        .leaderboard-item {
            cursor: pointer;
            transition: background 0.2s;
        }

        .leaderboard-item:hover {
            background: rgba(255,255,255,0.05);
        }

        .leaderboard-details {
            display: none;
            background: rgba(0,0,0,0.5);
            border-radius: 8px;
            padding: 10px;
            margin-top: 8px;
            font-size: 0.7rem;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .leaderboard-details.show {
            display: block;
        }

        .leaderboard-details-title {
            color: #feca57;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .leaderboard-body-info {
            display: flex;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .leaderboard-body-info:last-child {
            border-bottom: none;
        }

        .leaderboard-body-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .leaderboard-body-name {
            color: #fff;
            width: 60px;
        }

        .leaderboard-body-data {
            color: #888;
            flex: 1;
            font-family: 'Consolas', monospace;
        }

        .leaderboard-replay-btn {
            width: 100%;
            margin-top: 10px;
            padding: 8px;
            background: linear-gradient(135deg, #00b894, #00cec9);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .leaderboard-replay-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 184, 148, 0.4);
        }

        .leaderboard-era {
            display: flex;
            align-items: center;
            margin-bottom: 4px;
        }

        .leaderboard-era-label {
            color: #888;
            margin-right: 8px;
        }

        .leaderboard-era-value {
            color: #feca57;
            font-weight: bold;
        }

        .leaderboard-era-desc {
            color: #666;
            font-size: 0.65rem;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .leaderboard-cause {
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .leaderboard-cause-label {
            color: #888;
            margin-right: 8px;
        }

        .leaderboard-cause-value {
            color: #ff6b6b;
            font-size: 0.7rem;
        }

        /* ç»å…¸è§£é¢æ¿ */
        .classic-solutions {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            min-width: 200px;
            max-width: 240px;
        }

        .classic-solutions-title {
            font-size: 0.9rem;
            color: #1dd1a1;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .classic-solutions-title::before {
            content: 'âš–ï¸';
        }

        .classic-solution-item {
            padding: 8px 10px;
            margin-bottom: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .classic-solution-item:hover {
            background: rgba(29, 209, 161, 0.2);
            border-color: rgba(29, 209, 161, 0.3);
        }

        .classic-solution-item:last-child {
            margin-bottom: 0;
        }

        .classic-solution-name {
            font-size: 0.85rem;
            color: #fff;
            margin-bottom: 3px;
        }

        .classic-solution-desc {
            font-size: 0.7rem;
            color: #888;
        }

        /* å³ä¸Šè§’çŠ¶æ€æ˜¾ç¤º */
        .initial-state-info {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.8);
            padding: 12px 15px;
            border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.1);
            font-size: 0.75rem;
            min-width: 180px;
        }

        .initial-state-title {
            color: #feca57;
            margin-bottom: 8px;
            font-size: 0.8rem;
        }

        .initial-state-preset {
            color: #1dd1a1;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .initial-state-star {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 4px 0;
        }

        .initial-state-color {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .initial-state-name {
            color: #fff;
            width: 35px;
        }

        .initial-state-mass {
            color: #aaa;
        }

        .view-controls {
            display: flex;
            gap: 5px;
            margin-top: 10px;
        }

        .view-controls button {
            padding: 8px 12px;
            font-size: 0.75rem;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
        }

        .view-controls button:hover {
            box-shadow: 0 5px 20px rgba(108, 92, 231, 0.4);
        }
    </style>
</head>
<body>
    <div id="canvas-container">
        <canvas id="stars-canvas" class="stars"></canvas>
        <canvas id="simulation"></canvas>
        <div class="view-hint">
            ğŸ–±ï¸ å·¦é”®æ‹–æ‹½æ—‹è½¬ | æ»šè½®ç¼©æ”¾ | å³é”®æ‹–æ‹½å¹³ç§»
        </div>
        <div class="initial-state-info" id="initial-state-info">
            <div class="initial-state-title">å½“å‰åˆå§‹çŠ¶æ€</div>
            <div class="initial-state-preset" id="current-preset">éšæœºé…ç½®</div>
            <div id="initial-state-stars"></div>
        </div>
        <div class="leaderboard">
            <div class="leaderboard-title">æœ€é•¿å­˜ç»­æ–‡æ˜ TOP 10</div>
            <ul class="leaderboard-list" id="leaderboard-list">
                <div class="leaderboard-empty">æš‚æ— è®°å½•</div>
            </ul>
        </div>
        <div class="classic-solutions">
            <div class="classic-solutions-title">è´¨é‡æ¯”é¢„è®¾</div>
            <div class="classic-solution-item" onclick="loadMassPreset('oneBigTwoSmall')">
                <div class="classic-solution-name">ä¸€å¤§ä¸¤å°</div>
                <div class="classic-solution-desc">ä¸€é¢—å¤§æ’æ˜Ÿ + ä¸¤é¢—å°æ’æ˜Ÿ</div>
            </div>
            <div class="classic-solution-item" onclick="loadMassPreset('oneSmallTwoBig')">
                <div class="classic-solution-name">ä¸€å°ä¸¤å¤§</div>
                <div class="classic-solution-desc">ä¸€é¢—å°æ’æ˜Ÿ + ä¸¤é¢—å¤§æ’æ˜Ÿ</div>
            </div>
            <div class="classic-solution-item" onclick="loadMassPreset('allEqual')">
                <div class="classic-solution-name">ä¸‰æ˜ŸåŒè´¨</div>
                <div class="classic-solution-desc">ä¸‰é¢—æ’æ˜Ÿè´¨é‡ç›¸åŒ</div>
            </div>
        </div>
    </div>

    <div id="sidebar">
        <div id="resize-handle"></div>
        <h1>ä¸‰ä½“è¿åŠ¨æ¨¡æ‹Ÿ</h1>
        <p class="subtitle">åŸºäº Runge-Kutta 4é˜¶ç§¯åˆ†çš„çœŸå® 3D ç‰©ç†æ¨¡æ‹Ÿ</p>

        <div class="panel">
            <div class="civilization-number" id="civ-number">1</div>
            <div class="civilization-label">ç¬¬ N å·æ–‡æ˜</div>
        </div>

        <div class="panel">
            <div class="panel-title">å½“å‰çŠ¶æ€</div>
            <div class="status">
                <span class="status-label">æ–‡æ˜æŒç»­æ—¶é—´</span>
                <span class="status-value" id="duration">0 å¹´</span>
            </div>
            <div class="status">
                <span class="status-label">è¡Œæ˜Ÿè¡¨é¢æ¸©åº¦</span>
                <span class="status-value" id="temperature">-- K</span>
            </div>
            <div class="status">
                <span class="status-label">æœ€è¿‘æ’æ˜Ÿè·ç¦»</span>
                <span class="status-value" id="nearest-star">-- AU</span>
            </div>
            <div class="status">
                <span class="status-label">çºªå…ƒçŠ¶æ€</span>
                <span class="status-value" id="era-status">--</span>
            </div>

            <div class="temp-bar">
                <div class="survival-zone" style="left: 25%; width: 20%;"></div>
                <div class="temp-indicator" id="temp-indicator" style="left: 50%;"></div>
            </div>
            <div class="temp-labels">
                <span>0K</span>
                <span>150K</span>
                <span>273K</span>
                <span>373K</span>
                <span>500K</span>
                <span>1000K+</span>
            </div>

            <div class="info-box">
                <strong>ç”Ÿå‘½å­˜åœ¨æ¡ä»¶:</strong><br>
                æ¸©åº¦èŒƒå›´: 273K - 373K (0Â°C - 100Â°C)<br>
                æ¶²æ€æ°´å­˜åœ¨åŒºé—´ï¼Œç”Ÿå‘½å¯ç¹è¡<br>
                <span style="color:#ff6b6b;">< 150K: æ°¸ä¹…å†°å°ï¼Œæ–‡æ˜æ¯ç­</span><br>
                <span style="color:#ff6b6b;">> 500K: ç„šçƒ§æ®†å°½ï¼Œæ–‡æ˜æ¯ç­</span>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">æ¨¡æ‹Ÿæ§åˆ¶</div>
            <div class="controls">
                <button class="btn-pause" id="btn-pause" onclick="togglePause()">æš‚åœ</button>
                <button class="btn-reset" onclick="resetSimulation()">é‡ç½®</button>
            </div>
            <div class="speed-control">
                <span style="color:#888; font-size:0.8rem;">é€Ÿåº¦:</span>
                <input type="range" id="speed-slider" min="0" max="100" value="20" onchange="updateSpeed()" oninput="updateSpeed()">
            </div>
            <div class="controls" style="margin-top: 10px;">
                <button class="btn-speed" onclick="setSpeed(1)">1x</button>
                <button class="btn-speed" onclick="setSpeed(10)">10x</button>
                <button class="btn-speed" onclick="setSpeed(100)">100x</button>
                <button class="btn-speed" onclick="setSpeed(1000)">1000x</button>
            </div>
            <div class="speed-display">
                å½“å‰é€Ÿåº¦: <span id="speed-value">1x</span>
            </div>
            <div class="trail-toggle">
                <input type="checkbox" id="show-trails" checked onchange="toggleTrails()">
                <label for="show-trails">æ˜¾ç¤ºè¿åŠ¨è½¨è¿¹</label>
            </div>
            <div class="panel-title" style="margin-top: 15px;">3D è§†è§’</div>
            <div class="view-controls">
                <button onclick="resetView()">é‡ç½®è§†è§’</button>
                <button onclick="setViewXY()">ä¿¯è§† XY</button>
                <button onclick="setViewXZ()">ä¾§è§† XZ</button>
                <button onclick="setViewYZ()">ä¾§è§† YZ</button>
            </div>
            <div class="panel-title" style="margin-top: 15px;">è´¨é‡æ¯”è®¾ç½®</div>
            <div class="mass-ratio-control">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px;">
                    <span style="color:#888; font-size:0.8rem;">å¤§/å°æ’æ˜Ÿè´¨é‡æ¯”:</span>
                    <span id="mass-ratio-value" style="color:#1dd1a1; font-size:0.9rem;">2.0x ~ 4.0x</span>
                </div>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <input type="range" id="mass-ratio-min" min="10" max="250" value="20" style="flex:1;" oninput="updateMassRatioDisplay()">
                    <span style="color:#666;">~</span>
                    <input type="range" id="mass-ratio-max" min="10" max="500" value="40" style="flex:1;" oninput="updateMassRatioDisplay()">
                </div>
                <div style="display: flex; justify-content: space-between; color:#666; font-size:0.7rem; margin-top: 3px;">
                    <span>1x ~ 25x</span>
                    <span>1x ~ 50x</span>
                </div>
            </div>
        </div>

        <div class="panel" style="flex: 1; display: flex; flex-direction: column; min-height: 150px;">
            <div class="panel-title">æ–‡æ˜å†å²è®°å½•</div>
            <div class="history-list" id="history-list">
                <div style="color: #666; text-align: center; padding: 20px;">
                    ç­‰å¾…ç¬¬ä¸€ä¸ªæ–‡æ˜çš„ç»ˆç»“...
                </div>
            </div>
        </div>

        <div class="panel">
            <div class="panel-title">å›¾ä¾‹</div>
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background: #ff6b6b;"></div>
                    <span>æ’æ˜Ÿ Î±</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #feca57;"></div>
                    <span>æ’æ˜Ÿ Î²</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #48dbfb;"></div>
                    <span>æ’æ˜Ÿ Î³</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #1dd1a1;"></div>
                    <span>ä¸‰ä½“è¡Œæ˜Ÿ</span>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        // ==================== ç‰©ç†å¸¸æ•° ====================
        const G = 6.67430e-11;        // ä¸‡æœ‰å¼•åŠ›å¸¸æ•° (mÂ³/(kgÂ·sÂ²))
        const AU = 1.496e11;          // å¤©æ–‡å•ä½ (m)
        const M_SUN = 1.989e30;       // å¤ªé˜³è´¨é‡ (kg)
        const STEFAN_BOLTZMANN = 5.670374419e-8;  // æ–¯ç‰¹è—©-ç»å°”å…¹æ›¼å¸¸æ•°
        const L_SUN = 3.828e26;       // å¤ªé˜³å…‰åº¦ (W)

        // ==================== ç”Ÿå‘½å­˜åœ¨æ¸©åº¦é˜ˆå€¼ ====================
        const TEMP_MIN_LIFE = 273;    // æœ€ä½ç”Ÿå­˜æ¸©åº¦ (K) - æ°´çš„å†°ç‚¹
        const TEMP_MAX_LIFE = 373;    // æœ€é«˜ç”Ÿå­˜æ¸©åº¦ (K) - æ°´çš„æ²¸ç‚¹
        const TEMP_EXTINCTION_COLD = 150;   // å†°å°ç­ç»æ¸©åº¦ (K)
        const TEMP_EXTINCTION_HOT = 500;    // ç„šçƒ§ç­ç»æ¸©åº¦ (K)

        // ==================== å½“å‰è´¨é‡é¢„è®¾ ====================
        let currentMassPreset = null;  // null è¡¨ç¤ºéšæœº, 'oneBigTwoSmall', 'oneSmallTwoBig', 'allEqual'
        const presetNames = {
            'oneBigTwoSmall': 'ä¸€å¤§ä¸¤å°',
            'oneSmallTwoBig': 'ä¸€å°ä¸¤å¤§',
            'allEqual': 'ä¸‰æ˜ŸåŒè´¨'
        };

        // è·å–è´¨é‡æ¯”èŒƒå›´
        function getMassRatioRange() {
            const minSlider = document.getElementById('mass-ratio-min');
            const maxSlider = document.getElementById('mass-ratio-max');
            if (!minSlider || !maxSlider) return { min: 2.0, max: 4.0 };

            let minRatio = parseFloat(minSlider.value) / 10;
            let maxRatio = parseFloat(maxSlider.value) / 10;

            // ç¡®ä¿æœ€å°å€¼ä¸è¶…è¿‡æœ€å¤§å€¼
            if (minRatio > maxRatio) {
                minRatio = maxRatio;
            }

            return { min: minRatio, max: maxRatio };
        }

        // è·å–éšæœºè´¨é‡æ¯”ï¼ˆåœ¨èŒƒå›´å†…ï¼‰
        function getMassRatio() {
            const range = getMassRatioRange();
            return range.min + Math.random() * (range.max - range.min);
        }

        // æ›´æ–°è´¨é‡æ¯”æ˜¾ç¤º
        function updateMassRatioDisplay() {
            const range = getMassRatioRange();
            const display = document.getElementById('mass-ratio-value');
            if (display) {
                display.textContent = `${range.min.toFixed(1)}x ~ ${range.max.toFixed(1)}x`;
            }
        }

        // ==================== Canvas è®¾ç½® ====================
        const canvas = document.getElementById('simulation');
        const ctx = canvas.getContext('2d');
        const starsCanvas = document.getElementById('stars-canvas');
        const starsCtx = starsCanvas.getContext('2d');
        const container = document.getElementById('canvas-container');

        function resizeCanvas() {
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
            starsCanvas.width = container.clientWidth;
            starsCanvas.height = container.clientHeight;
            drawStarfield();
        }
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ç»˜åˆ¶æ˜Ÿç©ºèƒŒæ™¯
        function drawStarfield() {
            starsCtx.fillStyle = '#000';
            starsCtx.fillRect(0, 0, starsCanvas.width, starsCanvas.height);

            for (let i = 0; i < 500; i++) {
                const x = Math.random() * starsCanvas.width;
                const y = Math.random() * starsCanvas.height;
                const radius = Math.random() * 1.5;
                const opacity = Math.random() * 0.8 + 0.2;

                starsCtx.beginPath();
                starsCtx.arc(x, y, radius, 0, Math.PI * 2);
                starsCtx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
                starsCtx.fill();
            }
        }

        // ==================== 3D è§†è§’æ§åˆ¶ ====================
        let cameraRotationX = 0.5;   // ä¿¯ä»°è§’
        let cameraRotationY = 0;     // æ°´å¹³æ—‹è½¬è§’
        let cameraZoom = 1;          // ç¼©æ”¾
        let cameraPanX = 0;          // å¹³ç§» X
        let cameraPanY = 0;          // å¹³ç§» Y
        let isDragging = false;
        let isPanning = false;
        let lastMouseX = 0;
        let lastMouseY = 0;

        // 3D æŠ•å½±å‡½æ•°
        function project3D(x, y, z, centerX, centerY, scale) {
            // ç»• Y è½´æ—‹è½¬
            const cosY = Math.cos(cameraRotationY);
            const sinY = Math.sin(cameraRotationY);
            let x1 = x * cosY - z * sinY;
            let z1 = x * sinY + z * cosY;
            let y1 = y;

            // ç»• X è½´æ—‹è½¬
            const cosX = Math.cos(cameraRotationX);
            const sinX = Math.sin(cameraRotationX);
            let y2 = y1 * cosX - z1 * sinX;
            let z2 = y1 * sinX + z1 * cosX;
            let x2 = x1;

            // é€è§†æŠ•å½±
            const perspective = 1000;
            const fov = perspective / (perspective + z2 * scale * 0.1);

            const screenX = centerX + x2 * scale * cameraZoom * fov + cameraPanX;
            const screenY = centerY + y2 * scale * cameraZoom * fov + cameraPanY;

            return { x: screenX, y: screenY, z: z2, scale: fov };
        }

        // é¼ æ ‡äº‹ä»¶å¤„ç†
        canvas.addEventListener('mousedown', (e) => {
            if (e.button === 0) { // å·¦é”®
                isDragging = true;
            } else if (e.button === 2) { // å³é”®
                isPanning = true;
            }
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;
                cameraRotationY += deltaX * 0.005;
                cameraRotationX += deltaY * 0.005;
                // é™åˆ¶ä¿¯ä»°è§’
                cameraRotationX = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, cameraRotationX));
            }
            if (isPanning) {
                const deltaX = e.clientX - lastMouseX;
                const deltaY = e.clientY - lastMouseY;
                cameraPanX += deltaX;
                cameraPanY += deltaY;
            }
            lastMouseX = e.clientX;
            lastMouseY = e.clientY;
        });

        canvas.addEventListener('mouseup', () => {
            isDragging = false;
            isPanning = false;
        });

        canvas.addEventListener('mouseleave', () => {
            isDragging = false;
            isPanning = false;
        });

        canvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            cameraZoom *= zoomFactor;
            cameraZoom = Math.max(0.1, Math.min(10, cameraZoom));
        });

        canvas.addEventListener('contextmenu', (e) => e.preventDefault());

        // è§†è§’é¢„è®¾
        function resetView() {
            cameraRotationX = 0.5;
            cameraRotationY = 0;
            cameraZoom = 1;
            cameraPanX = 0;
            cameraPanY = 0;
        }

        function setViewXY() {
            cameraRotationX = 0;
            cameraRotationY = 0;
            cameraPanX = 0;
            cameraPanY = 0;
        }

        function setViewXZ() {
            cameraRotationX = Math.PI / 2;
            cameraRotationY = 0;
            cameraPanX = 0;
            cameraPanY = 0;
        }

        function setViewYZ() {
            cameraRotationX = 0;
            cameraRotationY = Math.PI / 2;
            cameraPanX = 0;
            cameraPanY = 0;
        }

        // ==================== æ¨¡æ‹ŸçŠ¶æ€ ====================
        let paused = false;
        let speedMultiplier = 1;
        let showTrails = true;
        let civilizationNumber = 1;
        let civilizationStartTime = 0;
        let simulationTime = 0;
        let history = [];
        let stars = [];
        let planet = null;

        // ==================== å¤©ä½“ç±» (3D) ====================
        class CelestialBody {
            constructor(x, y, z, vx, vy, vz, mass, radius, color, name, luminosity = 0) {
                this.x = x;
                this.y = y;
                this.z = z;
                this.vx = vx;
                this.vy = vy;
                this.vz = vz;
                this.mass = mass;
                this.physicalRadius = radius;
                this.color = color;
                this.name = name;
                this.luminosity = luminosity;
                this.trail = [];
                this.maxTrail = 800;
            }

            static calculateLuminosity(mass) {
                const massRatio = mass / M_SUN;
                return L_SUN * Math.pow(massRatio, 3.5);
            }

            addTrailPoint() {
                this.trail.push({ x: this.x, y: this.y, z: this.z });
                if (this.trail.length > this.maxTrail) {
                    this.trail.shift();
                }
            }

            clearTrail() {
                this.trail = [];
            }

            distanceTo(other) {
                const dx = this.x - other.x;
                const dy = this.y - other.y;
                const dz = this.z - other.z;
                return Math.sqrt(dx * dx + dy * dy + dz * dz);
            }
        }

        // ==================== Runge-Kutta 4é˜¶ç§¯åˆ†å™¨ (3D) ====================
        function computeAccelerations(bodies) {
            const n = bodies.length;
            const accelerations = new Array(n).fill(null).map(() => ({ ax: 0, ay: 0, az: 0 }));

            for (let i = 0; i < n; i++) {
                for (let j = 0; j < n; j++) {
                    if (i === j) continue;

                    const dx = bodies[j].x - bodies[i].x;
                    const dy = bodies[j].y - bodies[i].y;
                    const dz = bodies[j].z - bodies[i].z;
                    const r2 = dx * dx + dy * dy + dz * dz;

                    const softening = 1e9;
                    const r_soft = Math.sqrt(r2 + softening * softening);

                    const a = G * bodies[j].mass / (r_soft * r_soft);

                    accelerations[i].ax += a * dx / r_soft;
                    accelerations[i].ay += a * dy / r_soft;
                    accelerations[i].az += a * dz / r_soft;
                }
            }

            return accelerations;
        }

        function rk4Step(bodies, dt) {
            const n = bodies.length;

            const initial = bodies.map(b => ({
                x: b.x, y: b.y, z: b.z, vx: b.vx, vy: b.vy, vz: b.vz
            }));

            // k1
            const a1 = computeAccelerations(bodies);
            const k1 = bodies.map((b, i) => ({
                dx: b.vx, dy: b.vy, dz: b.vz,
                dvx: a1[i].ax, dvy: a1[i].ay, dvz: a1[i].az
            }));

            // k2
            bodies.forEach((b, i) => {
                b.x = initial[i].x + 0.5 * dt * k1[i].dx;
                b.y = initial[i].y + 0.5 * dt * k1[i].dy;
                b.z = initial[i].z + 0.5 * dt * k1[i].dz;
                b.vx = initial[i].vx + 0.5 * dt * k1[i].dvx;
                b.vy = initial[i].vy + 0.5 * dt * k1[i].dvy;
                b.vz = initial[i].vz + 0.5 * dt * k1[i].dvz;
            });
            const a2 = computeAccelerations(bodies);
            const k2 = bodies.map((b, i) => ({
                dx: b.vx, dy: b.vy, dz: b.vz,
                dvx: a2[i].ax, dvy: a2[i].ay, dvz: a2[i].az
            }));

            // k3
            bodies.forEach((b, i) => {
                b.x = initial[i].x + 0.5 * dt * k2[i].dx;
                b.y = initial[i].y + 0.5 * dt * k2[i].dy;
                b.z = initial[i].z + 0.5 * dt * k2[i].dz;
                b.vx = initial[i].vx + 0.5 * dt * k2[i].dvx;
                b.vy = initial[i].vy + 0.5 * dt * k2[i].dvy;
                b.vz = initial[i].vz + 0.5 * dt * k2[i].dvz;
            });
            const a3 = computeAccelerations(bodies);
            const k3 = bodies.map((b, i) => ({
                dx: b.vx, dy: b.vy, dz: b.vz,
                dvx: a3[i].ax, dvy: a3[i].ay, dvz: a3[i].az
            }));

            // k4
            bodies.forEach((b, i) => {
                b.x = initial[i].x + dt * k3[i].dx;
                b.y = initial[i].y + dt * k3[i].dy;
                b.z = initial[i].z + dt * k3[i].dz;
                b.vx = initial[i].vx + dt * k3[i].dvx;
                b.vy = initial[i].vy + dt * k3[i].dvy;
                b.vz = initial[i].vz + dt * k3[i].dvz;
            });
            const a4 = computeAccelerations(bodies);
            const k4 = bodies.map((b, i) => ({
                dx: b.vx, dy: b.vy, dz: b.vz,
                dvx: a4[i].ax, dvy: a4[i].ay, dvz: a4[i].az
            }));

            // æœ€ç»ˆæ›´æ–°
            bodies.forEach((b, i) => {
                b.x = initial[i].x + (dt / 6) * (k1[i].dx + 2*k2[i].dx + 2*k3[i].dx + k4[i].dx);
                b.y = initial[i].y + (dt / 6) * (k1[i].dy + 2*k2[i].dy + 2*k3[i].dy + k4[i].dy);
                b.z = initial[i].z + (dt / 6) * (k1[i].dz + 2*k2[i].dz + 2*k3[i].dz + k4[i].dz);
                b.vx = initial[i].vx + (dt / 6) * (k1[i].dvx + 2*k2[i].dvx + 2*k3[i].dvx + k4[i].dvx);
                b.vy = initial[i].vy + (dt / 6) * (k1[i].dvy + 2*k2[i].dvy + 2*k3[i].dvy + k4[i].dvy);
                b.vz = initial[i].vz + (dt / 6) * (k1[i].dvz + 2*k2[i].dvz + 2*k3[i].dvz + k4[i].dvz);
            });
        }

        // ==================== åˆå§‹åŒ–å¤©ä½“ (3D) ====================
        function initBodies() {
            // å¦‚æœæœ‰å½“å‰é¢„è®¾ï¼Œåˆ™ä½¿ç”¨é¢„è®¾ç”Ÿæˆè´¨é‡
            let masses;
            if (currentMassPreset) {
                const ratio = getMassRatio();
                const smallMass = (0.5 + Math.random() * 0.5) * M_SUN;
                const bigMass = smallMass * ratio;

                switch (currentMassPreset) {
                    case 'oneBigTwoSmall':
                        masses = [bigMass, smallMass, smallMass * (0.8 + Math.random() * 0.4)];
                        break;
                    case 'oneSmallTwoBig':
                        masses = [smallMass, bigMass, bigMass * (0.8 + Math.random() * 0.4)];
                        break;
                    case 'allEqual':
                        const equalMass = (0.8 + Math.random() * 0.4) * M_SUN;
                        masses = [equalMass, equalMass, equalMass];
                        break;
                    default:
                        masses = [
                            (0.5 + Math.random() * 1.5) * M_SUN,
                            (0.5 + Math.random() * 1.5) * M_SUN,
                            (0.5 + Math.random() * 1.5) * M_SUN
                        ];
                }
            } else {
                masses = [
                    (0.5 + Math.random() * 1.5) * M_SUN,
                    (0.5 + Math.random() * 1.5) * M_SUN,
                    (0.5 + Math.random() * 1.5) * M_SUN
                ];
            }

            const baseRadius = (10 + Math.random() * 20) * AU;
            const totalMass = masses.reduce((a, b) => a + b, 0);

            const colors = ['#ff6b6b', '#feca57', '#48dbfb'];
            const names = ['Î±', 'Î²', 'Î³'];

            stars = [];
            let comX = 0, comY = 0, comZ = 0, comVx = 0, comVy = 0, comVz = 0;

            for (let i = 0; i < 3; i++) {
                const r = baseRadius * (0.5 + Math.random());
                // éšæœº 3D è§’åº¦
                const theta = Math.random() * 2 * Math.PI;
                const phi = Math.acos(2 * Math.random() - 1);

                const x = r * Math.sin(phi) * Math.cos(theta);
                const y = r * Math.sin(phi) * Math.sin(theta);
                const z = r * Math.cos(phi);

                const orbitalV = Math.sqrt(G * totalMass / r) * (0.2 + Math.random() * 0.6);
                const vTheta = Math.random() * 2 * Math.PI;
                const vPhi = Math.acos(2 * Math.random() - 1);

                const vx = orbitalV * Math.sin(vPhi) * Math.cos(vTheta);
                const vy = orbitalV * Math.sin(vPhi) * Math.sin(vTheta);
                const vz = orbitalV * Math.cos(vPhi);

                const starRadius = 7e8 * Math.pow(masses[i] / M_SUN, 0.8);
                const luminosity = CelestialBody.calculateLuminosity(masses[i]);

                const star = new CelestialBody(
                    x, y, z, vx, vy, vz,
                    masses[i], starRadius,
                    colors[i], names[i], luminosity
                );
                stars.push(star);

                comX += x * masses[i];
                comY += y * masses[i];
                comZ += z * masses[i];
                comVx += vx * masses[i];
                comVy += vy * masses[i];
                comVz += vz * masses[i];
            }

            // æ ¡æ­£åˆ°è´¨å¿ƒå‚è€ƒç³»
            comX /= totalMass;
            comY /= totalMass;
            comZ /= totalMass;
            comVx /= totalMass;
            comVy /= totalMass;
            comVz /= totalMass;

            stars.forEach(star => {
                star.x -= comX;
                star.y -= comY;
                star.z -= comZ;
                star.vx -= comVx;
                star.vy -= comVy;
                star.vz -= comVz;
            });

            // åˆå§‹åŒ–è¡Œæ˜Ÿ
            const planetR = (3 + Math.random() * 7) * AU;
            const pTheta = Math.random() * 2 * Math.PI;
            const pPhi = Math.acos(2 * Math.random() - 1);

            const planetOrbitalV = Math.sqrt(G * totalMass / planetR) * (0.7 + Math.random() * 0.6);
            // é€Ÿåº¦å¤§è‡´å‚ç›´äºä½ç½®å‘é‡
            const pvTheta = pTheta + Math.PI / 2;
            const pvPhi = Math.PI / 2;

            planet = new CelestialBody(
                planetR * Math.sin(pPhi) * Math.cos(pTheta),
                planetR * Math.sin(pPhi) * Math.sin(pTheta),
                planetR * Math.cos(pPhi),
                planetOrbitalV * Math.sin(pvPhi) * Math.cos(pvTheta),
                planetOrbitalV * Math.sin(pvPhi) * Math.sin(pvTheta),
                planetOrbitalV * Math.cos(pvPhi) * 0.3,
                5.972e24,
                6.371e6,
                '#1dd1a1',
                'ä¸‰ä½“è¡Œæ˜Ÿ',
                0
            );

            civilizationStartTime = simulationTime;

            // ä¿å­˜åˆå§‹çŠ¶æ€ç”¨äºå¤ç°
            currentInitialState = saveCurrentState();

            // æ›´æ–°å³ä¸Šè§’çŠ¶æ€æ˜¾ç¤º
            updateInitialStateDisplay();
        }

        // ==================== è´¨é‡æ¯”é¢„è®¾ ====================
        function loadMassPreset(presetType) {
            const colors = ['#ff6b6b', '#feca57', '#48dbfb'];
            const names = ['Î±', 'Î²', 'Î³'];

            // ä½¿ç”¨ç”¨æˆ·è®¾ç½®çš„è´¨é‡æ¯”
            const ratio = getMassRatio();
            const smallMass = (0.5 + Math.random() * 0.5) * M_SUN;
            const bigMass = smallMass * ratio;

            let masses;
            let presetName;

            switch (presetType) {
                case 'oneBigTwoSmall':
                    // ä¸€å¤§ä¸¤å°ï¼šç¬¬ä¸€é¢—å¤§ï¼Œåä¸¤é¢—å°
                    masses = [bigMass, smallMass, smallMass * (0.8 + Math.random() * 0.4)];
                    presetName = 'ä¸€å¤§ä¸¤å°';
                    break;
                case 'oneSmallTwoBig':
                    // ä¸€å°ä¸¤å¤§ï¼šç¬¬ä¸€é¢—å°ï¼Œåä¸¤é¢—å¤§
                    masses = [smallMass, bigMass, bigMass * (0.8 + Math.random() * 0.4)];
                    presetName = 'ä¸€å°ä¸¤å¤§';
                    break;
                case 'allEqual':
                    // ä¸‰æ˜ŸåŒè´¨
                    const equalMass = (0.8 + Math.random() * 0.4) * M_SUN;
                    masses = [equalMass, equalMass, equalMass];
                    presetName = 'ä¸‰æ˜ŸåŒè´¨';
                    break;
                default:
                    return;
            }

            // éšæœºç”Ÿæˆä½ç½®å’Œé€Ÿåº¦ï¼ˆå¤ç”¨ initBodies çš„é€»è¾‘ï¼‰
            const baseDistance = AU * (1.5 + Math.random());

            stars = [];
            for (let i = 0; i < 3; i++) {
                const angle = (i / 3) * Math.PI * 2 + Math.random() * 0.5;
                const dist = baseDistance * (0.8 + Math.random() * 0.4);
                const zOffset = (Math.random() - 0.5) * baseDistance * 0.3;

                const x = dist * Math.cos(angle);
                const y = dist * Math.sin(angle);
                const z = zOffset;

                // è®¡ç®—è½¨é“é€Ÿåº¦
                const totalOtherMass = masses.reduce((sum, m, idx) => idx !== i ? sum + m : sum, 0);
                const orbitalV = Math.sqrt(G * totalOtherMass / dist) * (0.8 + Math.random() * 0.4);

                const vAngle = angle + Math.PI / 2 + (Math.random() - 0.5) * 0.3;
                const vx = orbitalV * Math.cos(vAngle);
                const vy = orbitalV * Math.sin(vAngle);
                const vz = (Math.random() - 0.5) * orbitalV * 0.2;

                // è®¡ç®—å…‰åº¦ï¼ˆä¸è´¨é‡çš„3.5æ¬¡æ–¹æˆæ­£æ¯”ï¼‰
                const luminosity = L_SUN * Math.pow(masses[i] / M_SUN, 3.5);

                stars.push(new CelestialBody(
                    x, y, z, vx, vy, vz,
                    masses[i],
                    6.96e8 * Math.pow(masses[i] / M_SUN, 0.8),
                    colors[i], names[i],
                    luminosity
                ));
            }

            // æ”¾ç½®è¡Œæ˜Ÿ
            const totalMass = masses.reduce((a, b) => a + b, 0);
            const planetR = AU * (2 + Math.random());
            const pTheta = Math.random() * Math.PI * 2;
            const pPhi = Math.PI / 2 + (Math.random() - 0.5) * 0.3;

            const planetOrbitalV = Math.sqrt(G * totalMass / planetR) * (0.3 + Math.random() * 0.2);

            planet = new CelestialBody(
                planetR * Math.sin(pPhi) * Math.cos(pTheta),
                planetR * Math.sin(pPhi) * Math.sin(pTheta),
                planetR * Math.cos(pPhi),
                planetOrbitalV * Math.sin(pTheta + Math.PI/2),
                planetOrbitalV * Math.cos(pTheta + Math.PI/2),
                0,
                5.972e24,
                6.371e6,
                '#1dd1a1',
                'ä¸‰ä½“è¡Œæ˜Ÿ',
                0
            );

            simulationTime = 0;
            civilizationStartTime = 0;
            currentInitialState = saveCurrentState();

            // è®¾ç½®å½“å‰é¢„è®¾
            currentMassPreset = presetType;

            // æ›´æ–°å³ä¸Šè§’çŠ¶æ€æ˜¾ç¤º
            updateInitialStateDisplay();

            // æ˜¾ç¤ºè´¨é‡ä¿¡æ¯
            const massInfo = masses.map((m, i) => `${names[i]}:${(m/M_SUN).toFixed(2)}Mâ˜‰`).join(' ');
            resetView();
            showNotification(`${presetName} - ${massInfo}`);
        }

        // æ›´æ–°å³ä¸Šè§’åˆå§‹çŠ¶æ€æ˜¾ç¤º
        function updateInitialStateDisplay() {
            const presetEl = document.getElementById('current-preset');
            const starsEl = document.getElementById('initial-state-stars');

            // æ˜¾ç¤ºå½“å‰é¢„è®¾
            if (currentMassPreset && presetNames[currentMassPreset]) {
                presetEl.textContent = presetNames[currentMassPreset];
            } else {
                presetEl.textContent = 'éšæœºé…ç½®';
            }

            // æ˜¾ç¤ºæ’æ˜Ÿè´¨é‡
            starsEl.innerHTML = stars.map(s => `
                <div class="initial-state-star">
                    <span class="initial-state-color" style="background: ${s.color}"></span>
                    <span class="initial-state-name">æ’æ˜Ÿ ${s.name}</span>
                    <span class="initial-state-mass">${(s.mass / M_SUN).toFixed(2)} Mâ˜‰</span>
                </div>
            `).join('');
        }

        // ä¿å­˜å½“å‰çŠ¶æ€
        function saveCurrentState() {
            return {
                stars: stars.map(s => ({
                    x: s.x, y: s.y, z: s.z,
                    vx: s.vx, vy: s.vy, vz: s.vz,
                    mass: s.mass,
                    physicalRadius: s.physicalRadius,
                    color: s.color,
                    name: s.name,
                    luminosity: s.luminosity
                })),
                planet: {
                    x: planet.x, y: planet.y, z: planet.z,
                    vx: planet.vx, vy: planet.vy, vz: planet.vz,
                    mass: planet.mass,
                    physicalRadius: planet.physicalRadius
                }
            };
        }

        // ä»ä¿å­˜çš„çŠ¶æ€æ¢å¤
        function restoreState(state) {
            const colors = ['#ff6b6b', '#feca57', '#48dbfb'];
            const names = ['Î±', 'Î²', 'Î³'];

            stars = state.stars.map((s, i) => {
                const star = new CelestialBody(
                    s.x, s.y, s.z, s.vx, s.vy, s.vz,
                    s.mass, s.physicalRadius,
                    s.color || colors[i], s.name || names[i], s.luminosity
                );
                return star;
            });

            planet = new CelestialBody(
                state.planet.x, state.planet.y, state.planet.z,
                state.planet.vx, state.planet.vy, state.planet.vz,
                state.planet.mass, state.planet.physicalRadius,
                '#1dd1a1', 'ä¸‰ä½“è¡Œæ˜Ÿ', 0
            );

            simulationTime = 0;
            civilizationStartTime = 0;
            currentInitialState = state;
        }

        // å¤ç°æŒ‡å®šæ–‡æ˜ï¼ˆé€šè¿‡æ–‡æ˜ç¼–å·ï¼‰
        function replayCivilizationByNumber(civNumber) {
            const record = history.find(h => h.number === civNumber);
            if (record && record.initialState) {
                restoreState(record.initialState);
                showNotification(`æ­£åœ¨å¤ç°ç¬¬ ${record.number} å·æ–‡æ˜çš„åˆå§‹çŠ¶æ€`);
                // ä¸å…³é—­å±•å¼€çš„è¯¦æƒ…ï¼Œè®©ç”¨æˆ·å¯ä»¥ç»§ç»­æŸ¥çœ‹
            }
        }

        // å½“å‰åˆå§‹çŠ¶æ€
        let currentInitialState = null;

        // å½“å‰å±•å¼€çš„æ’è¡Œæ¦œè¯¦æƒ…çš„æ–‡æ˜ç¼–å·ï¼ˆç”¨ç¼–å·è€Œä¸æ˜¯ç´¢å¼•ï¼Œé¿å…æ’åºå˜åŒ–æ—¶é”™ä½ï¼‰
        let currentExpandedCivNumber = -1;

        // æ’è¡Œæ¦œç¼“å­˜ï¼Œé¿å…é«˜å€é€Ÿä¸‹é¢‘ç¹é‡æ–°æ¸²æŸ“å¯¼è‡´æ— æ³•ç‚¹å‡»
        let lastLeaderboardKey = '';

        // ==================== æ–‡æ˜æ—¶ä»£åˆ¤å®šï¼ˆä¸‰ä½“æ–‡æ˜ï¼šè®°å¿†å¯é—ä¼ ï¼Œå‘å±•é€Ÿåº¦è¿œè¶…äººç±»ï¼‰ ====================
        function getCivilizationEra(years) {
            // ä¸‰ä½“äººè®°å¿†å¯é—ä¼ ï¼Œæ— éœ€é‡æ–°å­¦ä¹ ï¼Œæ–‡æ˜ç§¯ç´¯æ•ˆç‡æé«˜
            // å‘å±•é€Ÿåº¦çº¦ä¸ºäººç±»æ–‡æ˜çš„10-50å€
            if (years < 1) return { era: 'æ–‡æ˜èŒèŠ½', desc: 'è„±æ°´çŠ¶æ€ä¸­çš„åŸå§‹ç”Ÿå‘½' };
            if (years < 5) return { era: 'åŸå§‹éƒ¨è½', desc: 'å¼€å§‹å½¢æˆç¾¤ä½“æ„è¯†' };
            if (years < 20) return { era: 'æ°æ—æ—¶ä»£', desc: 'è®°å¿†é—ä¼ åŠ é€ŸçŸ¥è¯†ä¼ æ‰¿' };
            if (years < 50) return { era: 'åŸé‚¦æ—¶ä»£', desc: 'å»ºç«‹ç¨³å®šçºªå…ƒé¢„æµ‹ä½“ç³»' };
            if (years < 100) return { era: 'ç‹æœæ—¶ä»£', desc: 'å¤§è§„æ¨¡è„±æ°´å‚¨å­˜æŠ€æœ¯æˆç†Ÿ' };
            if (years < 200) return { era: 'ç§‘å­¦å¯è’™', desc: 'å¼€å§‹ç†æ€§è®¤è¯†ä¸‰ä½“è¿åŠ¨' };
            if (years < 500) return { era: 'å·¥ä¸šæ—¶ä»£', desc: 'å»ºé€ åœ°ä¸‹åŸå¸‚èº²é¿ä¹±çºªå…ƒ' };
            if (years < 1000) return { era: 'åŸå­æ—¶ä»£', desc: 'æŒæ¡æ ¸èƒ½ï¼Œå°è¯•é¢„æµ‹æ’æ˜Ÿè½¨é“' };
            if (years < 2000) return { era: 'ä¿¡æ¯æ—¶ä»£', desc: 'è¶…çº§è®¡ç®—æœºæ¨¡æ‹Ÿä¸‰ä½“é—®é¢˜' };
            if (years < 5000) return { era: 'å¤ªç©ºæ—¶ä»£', desc: 'å‘å°„æ¢æµ‹å™¨ç ”ç©¶æ’æ˜Ÿ' };
            if (years < 10000) return { era: 'æ’æ˜Ÿé™…æ—¶ä»£', desc: 'å¼€å§‹å¯»æ‰¾å®œå±…æ˜Ÿç³»' };
            if (years < 50000) return { era: 'èˆ°é˜Ÿæ—¶ä»£', desc: 'å»ºé€ æ˜Ÿé™…èˆ°é˜Ÿï¼Œå‡†å¤‡è¿œå¾' };
            if (years < 100000) return { era: 'è¿œå¾æ—¶ä»£', desc: 'å‘å…¶ä»–æ’æ˜Ÿç³»æ´¾é£èˆ°é˜Ÿ' };
            if (years < 500000) return { era: 'æ®–æ°‘æ—¶ä»£', desc: 'åœ¨å¤šä¸ªæ˜Ÿç³»å»ºç«‹æ®–æ°‘åœ°' };
            if (years < 1000000) return { era: 'æ˜ŸåŸŸæ–‡æ˜', desc: 'ç»Ÿæ²»æ•°åä¸ªæ’æ˜Ÿç³»ç»Ÿ' };
            if (years < 10000000) return { era: 'é“¶æ²³æ–‡æ˜', desc: 'æ¥è¿‘IIå‹å¡å°”è¾¾è‚–å¤«æ–‡æ˜' };
            if (years < 100000000) return { era: 'è¶…çº§æ–‡æ˜', desc: 'æŒæ¡ç»´åº¦æ“æ§æŠ€æœ¯' };
            return { era: 'ç¥çº§æ–‡æ˜', desc: 'è¶…è¶Šç‰©ç†æ³•åˆ™çš„å­˜åœ¨' };
        }

        // ==================== è®¡ç®—è¡Œæ˜Ÿè¡¨é¢æ¸©åº¦ ====================
        function calculatePlanetTemperature() {
            let totalFlux = 0;

            for (const star of stars) {
                const dist = planet.distanceTo(star);
                const flux = star.luminosity / (4 * Math.PI * dist * dist);
                totalFlux += flux;
            }

            const albedo = 0.3;
            const absorbedFlux = totalFlux * (1 - albedo);
            const temperature = Math.pow(absorbedFlux / STEFAN_BOLTZMANN, 0.25);

            return temperature;
        }

        // ==================== æ£€æŸ¥æ–‡æ˜çŠ¶æ€ ====================
        function checkCivilization() {
            const temperature = calculatePlanetTemperature();

            let minDist = Infinity;
            let nearestStar = null;
            let maxTidalForce = 0;
            let totalRadiationPressure = 0;

            for (const star of stars) {
                const dist = planet.distanceTo(star);

                if (dist < minDist) {
                    minDist = dist;
                    nearestStar = star;
                }

                const tidalForce = G * star.mass * planet.physicalRadius / (dist * dist * dist);
                maxTidalForce = Math.max(maxTidalForce, tidalForce);

                const radiationPressure = star.luminosity / (4 * Math.PI * dist * dist * 3e8);
                totalRadiationPressure += radiationPressure;
            }

            const planetSpeed = Math.sqrt(planet.vx * planet.vx + planet.vy * planet.vy + planet.vz * planet.vz);

            let radialVelocity = 0;
            if (nearestStar) {
                const dx = planet.x - nearestStar.x;
                const dy = planet.y - nearestStar.y;
                const dz = planet.z - nearestStar.z;
                const dist = Math.sqrt(dx * dx + dy * dy + dz * dz);
                radialVelocity = (planet.vx * dx + planet.vy * dy + planet.vz * dz) / dist;
            }

            // æ›´æ–°UI
            const tempEl = document.getElementById('temperature');
            const nearestEl = document.getElementById('nearest-star');
            const eraEl = document.getElementById('era-status');
            const indicatorEl = document.getElementById('temp-indicator');

            tempEl.textContent = temperature.toFixed(0) + ' K (' + (temperature - 273).toFixed(0) + 'Â°C)';
            nearestEl.textContent = (minDist / AU).toFixed(2) + ' AU';

            const tempPercent = Math.min(100, Math.max(0, temperature / 1000 * 100));
            indicatorEl.style.left = tempPercent + '%';

            let eraStatus = '';
            let statusClass = '';

            if (temperature >= TEMP_MIN_LIFE && temperature <= TEMP_MAX_LIFE) {
                eraStatus = 'æ’çºªå…ƒ - å®œå±…';
                statusClass = 'safe';
            } else if (temperature < TEMP_MIN_LIFE && temperature >= TEMP_EXTINCTION_COLD) {
                eraStatus = 'ä¹±çºªå…ƒ - å¯’å†·';
                statusClass = 'warning';
            } else if (temperature > TEMP_MAX_LIFE && temperature <= TEMP_EXTINCTION_HOT) {
                eraStatus = 'ä¹±çºªå…ƒ - ç‚çƒ­';
                statusClass = 'warning';
            } else if (temperature < TEMP_EXTINCTION_COLD) {
                eraStatus = 'ä¹±çºªå…ƒ - æå¯’';
                statusClass = 'danger';
            } else {
                eraStatus = 'ä¹±çºªå…ƒ - æçƒ­';
                statusClass = 'danger';
            }

            tempEl.className = 'status-value ' + statusClass;
            eraEl.className = 'status-value ' + statusClass;
            eraEl.textContent = eraStatus;

            // ==================== æ–‡æ˜æ¯ç­æ¡ä»¶æ£€æµ‹ ====================

            // 1. æ¸©åº¦è¿‡ä½ - æ°¸ä¹…å†°å°
            if (temperature < TEMP_EXTINCTION_COLD) {
                endCivilization('æ°¸ä¹…å†°å° (æ¸©åº¦é™è‡³ ' + temperature.toFixed(0) + 'K)');
                return false;
            }

            // 2. æ¸©åº¦è¿‡é«˜ - ç„šçƒ§æ®†å°½
            if (temperature > TEMP_EXTINCTION_HOT) {
                endCivilization('ç„šçƒ§æ®†å°½ (æ¸©åº¦å‡è‡³ ' + temperature.toFixed(0) + 'K)');
                return false;
            }

            // 3. æ´›å¸Œæé™ - è¢«æ½®æ±åŠ›æ’•ç¢
            const planetSurfaceGravity = G * planet.mass / (planet.physicalRadius * planet.physicalRadius);
            const rocheLimit = 2.44 * nearestStar.physicalRadius * Math.pow(nearestStar.mass / planet.mass, 1/3);

            if (minDist < rocheLimit) {
                endCivilization('çªç ´æ´›å¸Œæé™ï¼Œè¢«æ’æ˜Ÿ ' + nearestStar.name + ' çš„æ½®æ±åŠ›æ’•ç¢');
                return false;
            }

            // 4. å å…¥æ’æ˜Ÿ - è¢«åå™¬
            for (const star of stars) {
                const dist = planet.distanceTo(star);
                if (dist < star.physicalRadius * 1.5) {
                    endCivilization('å å…¥æ’æ˜Ÿ ' + star.name + 'ï¼Œè¢«é«˜æ¸©ç­‰ç¦»å­ä½“åå™¬');
                    return false;
                }
            }

            // 5. é«˜é€Ÿæ’å‡»æ’æ˜Ÿ
            const escapeVelocity = Math.sqrt(2 * G * nearestStar.mass / minDist);
            if (minDist < nearestStar.physicalRadius * 5 && planetSpeed > escapeVelocity * 0.8 && radialVelocity < 0) {
                if (minDist < nearestStar.physicalRadius * 2) {
                    endCivilization('é«˜é€Ÿæ’å‡»æ’æ˜Ÿ ' + nearestStar.name + 'ï¼ŒåŠ¨èƒ½è½¬åŒ–ä¸ºæ¯ç­æ€§å†²å‡»');
                    return false;
                }
            }

            // 6. æ’æ˜Ÿé£å‰¥ç¦»å¤§æ°”
            const criticalRadiationPressure = 1e-4;
            if (totalRadiationPressure > criticalRadiationPressure && minDist < 0.5 * AU) {
                endCivilization('å¤§æ°”è¢«æ’æ˜Ÿé£å‰¥ç¦»ï¼Œè¡Œæ˜Ÿè¡¨é¢ç›´æ¥æš´éœ²äºè‡´å‘½è¾å°„');
                return false;
            }

            // 7. ä¸‰æ˜Ÿå¼•åŠ›å…±æŒ¯æ’•è£‚
            let strongGravityCount = 0;
            for (const star of stars) {
                const dist = planet.distanceTo(star);
                if (dist < 3 * AU) {
                    strongGravityCount++;
                }
            }
            if (strongGravityCount >= 2 && minDist < 1 * AU) {
                const tidalStress = maxTidalForce / planetSurfaceGravity;
                if (tidalStress > 0.1) {
                    endCivilization('é™·å…¥å¤šæ˜Ÿå¼•åŠ›å…±æŒ¯åŒºï¼Œè¡Œæ˜Ÿåœ°å£³è¢«æ’•è£‚');
                    return false;
                }
            }

            // 8. è¢«æŠ›å‡ºæ˜Ÿç³» - æµæµªè¡Œæ˜Ÿ
            const distFromCenter = Math.sqrt(planet.x * planet.x + planet.y * planet.y + planet.z * planet.z);
            if (distFromCenter > 500 * AU) {
                endCivilization('è¢«å¼•åŠ›å¼¹å¼“æ•ˆåº”æŠ›å‡ºæ˜Ÿç³»ï¼Œæˆä¸ºæµæµªè¡Œæ˜Ÿ (è·ç¦» ' + (distFromCenter / AU).toFixed(0) + ' AU)');
                return false;
            }

            // 9. è½¨é“è¡°å‡ - èºæ—‹å å…¥
            if (minDist < 0.3 * AU && radialVelocity < -50000) {
                endCivilization('è½¨é“è¡°å‡ï¼Œèºæ—‹å å…¥æ’æ˜Ÿ ' + nearestStar.name);
                return false;
            }

            // 10. æç«¯æ¸©åº¦éœ‡è¡
            if (temperature > 400 && minDist > 10 * AU) {
                endCivilization('æç«¯æ¸©åº¦éœ‡è¡ï¼Œåœ°å£³åº”åŠ›å´©è§£');
                return false;
            }

            return true;
        }

        // ==================== æ–‡æ˜ç»ˆç»“ ====================
        function endCivilization(cause) {
            const durationSeconds = simulationTime - civilizationStartTime;
            const years = durationSeconds / (365.25 * 24 * 3600);

            history.unshift({
                number: civilizationNumber,
                duration: years,
                cause: cause,
                initialState: currentInitialState  // ä¿å­˜åˆå§‹çŠ¶æ€ç”¨äºå¤ç°
            });

            // é™åˆ¶å†å²è®°å½•æ•°é‡ï¼Œä½†è¦ä¿ç•™ TOP 10 æœ€é•¿å­˜ç»­çš„æ–‡æ˜
            if (history.length > 50) {
                // æ‰¾å‡º TOP 10 çš„æ–‡æ˜ç¼–å·
                const top10Numbers = new Set(
                    [...history]
                        .sort((a, b) => b.duration - a.duration)
                        .slice(0, 10)
                        .map(h => h.number)
                );

                // ä»åå¾€å‰æ‰¾ï¼Œåˆ é™¤ç¬¬ä¸€ä¸ªä¸åœ¨ TOP 10 ä¸­çš„è®°å½•
                for (let i = history.length - 1; i >= 0; i--) {
                    if (!top10Numbers.has(history[i].number)) {
                        history.splice(i, 1);
                        break;
                    }
                }
            }

            updateHistoryDisplay();
            showNotification(`ç¬¬ ${civilizationNumber} å·æ–‡æ˜æ¯ç­: ${cause}`);

            civilizationNumber++;
            document.getElementById('civ-number').textContent = civilizationNumber;

            simulationTime = 0;
            initBodies();
        }

        // ==================== UI æ›´æ–°å‡½æ•° ====================
        function updateHistoryDisplay() {
            const listEl = document.getElementById('history-list');

            if (history.length === 0) {
                listEl.innerHTML = '<div style="color: #666; text-align: center; padding: 20px;">ç­‰å¾…ç¬¬ä¸€ä¸ªæ–‡æ˜çš„ç»ˆç»“...</div>';
                return;
            }

            listEl.innerHTML = history.map(h => {
                let category = 'short';
                if (h.duration > 100000) category = 'long';
                else if (h.duration > 10000) category = 'medium';

                return `
                    <div class="history-item ${category}">
                        <div class="history-header">
                            <span class="history-civ">ç¬¬ ${h.number} å·æ–‡æ˜</span>
                            <span class="history-time">${formatDuration(h.duration)}</span>
                        </div>
                        <div class="history-cause">${h.cause}</div>
                    </div>
                `;
            }).join('');

            // åŒæ—¶æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboard();
        }

        function updateLeaderboard() {
            const leaderboardEl = document.getElementById('leaderboard-list');

            if (history.length === 0) {
                if (lastLeaderboardKey !== 'empty') {
                    leaderboardEl.innerHTML = '<div class="leaderboard-empty">æš‚æ— è®°å½•</div>';
                    lastLeaderboardKey = 'empty';
                }
                return;
            }

            // æŒ‰æŒç»­æ—¶é—´æ’åºï¼Œå–å‰10
            let sorted = [...history].sort((a, b) => b.duration - a.duration).slice(0, 10);

            // ç”Ÿæˆå½“å‰æ’è¡Œæ¦œçš„å”¯ä¸€æ ‡è¯†ï¼ˆåªåŒ…å«å½±å“æ˜¾ç¤ºçš„å…³é”®ä¿¡æ¯ï¼‰
            const currentKey = sorted.map(h => `${h.number}:${h.duration.toFixed(0)}`).join('|');

            // å¦‚æœæ’è¡Œæ¦œå†…å®¹æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡é‡æ–°æ¸²æŸ“ï¼ˆé¿å…é«˜å€é€Ÿä¸‹é¢‘ç¹åˆ·æ–°å¯¼è‡´æ— æ³•ç‚¹å‡»ï¼‰
            if (currentKey === lastLeaderboardKey) {
                return;
            }
            lastLeaderboardKey = currentKey;

            // å¦‚æœå½“å‰å±•å¼€çš„æ–‡æ˜ä¸åœ¨ TOP 10 ä¸­ï¼ŒæŠŠå®ƒåŠ å…¥åˆ—è¡¨æœ«å°¾ï¼ˆç¡®ä¿ç”¨æˆ·èƒ½ç»§ç»­æŸ¥çœ‹ï¼‰
            if (currentExpandedCivNumber >= 0) {
                const expandedInTop10 = sorted.some(h => h.number === currentExpandedCivNumber);
                if (!expandedInTop10) {
                    const expandedRecord = history.find(h => h.number === currentExpandedCivNumber);
                    if (expandedRecord) {
                        sorted.push(expandedRecord);
                    }
                }
            }

            leaderboardEl.innerHTML = sorted.map((h, index) => {
                // åˆ¤æ–­æ˜¯å¦æ˜¯è¢«ä¿ç•™çš„å±•å¼€é¡¹ï¼ˆä¸åœ¨åŸ TOP 10 ä¸­ï¼‰
                const isKeptForExpanded = index >= 10;

                let rankClass = 'normal';
                if (!isKeptForExpanded) {
                    if (index === 0) rankClass = 'gold';
                    else if (index === 1) rankClass = 'silver';
                    else if (index === 2) rankClass = 'bronze';
                }

                // è·å–æ–‡æ˜æ—¶ä»£
                const eraInfo = getCivilizationEra(h.duration);

                // ç”Ÿæˆåˆå§‹çŠ¶æ€è¯¦æƒ…
                let detailsHtml = '';
                if (h.initialState) {
                    const state = h.initialState;
                    detailsHtml = `
                        <div class="leaderboard-details" id="details-civ-${h.number}">
                            <div class="leaderboard-era">
                                <span class="leaderboard-era-label">æ–‡æ˜é˜¶æ®µ:</span>
                                <span class="leaderboard-era-value">${eraInfo.era}</span>
                            </div>
                            <div class="leaderboard-era-desc">${eraInfo.desc}</div>
                            <div class="leaderboard-cause">
                                <span class="leaderboard-cause-label">æ¯ç­åŸå› :</span>
                                <span class="leaderboard-cause-value">${h.cause}</span>
                            </div>
                            <div class="leaderboard-details-title">åˆå§‹çŠ¶æ€</div>
                            ${state.stars.map((s, i) => `
                                <div class="leaderboard-body-info">
                                    <span class="leaderboard-body-color" style="background: ${s.color}"></span>
                                    <span class="leaderboard-body-name">æ’æ˜Ÿ ${s.name}</span>
                                    <span class="leaderboard-body-data">
                                        ${(s.mass / M_SUN).toFixed(2)}Mâ˜‰ |
                                        r=${(Math.sqrt(s.x*s.x + s.y*s.y + s.z*s.z) / AU).toFixed(1)}AU
                                    </span>
                                </div>
                            `).join('')}
                            <div class="leaderboard-body-info">
                                <span class="leaderboard-body-color" style="background: #1dd1a1"></span>
                                <span class="leaderboard-body-name">è¡Œæ˜Ÿ</span>
                                <span class="leaderboard-body-data">
                                    r=${(Math.sqrt(state.planet.x*state.planet.x + state.planet.y*state.planet.y + state.planet.z*state.planet.z) / AU).toFixed(1)}AU
                                </span>
                            </div>
                            <button class="leaderboard-replay-btn" onclick="event.stopPropagation(); replayCivilizationByNumber(${h.number})">
                                ğŸ”„ å¤ç°æ­¤æ–‡æ˜
                            </button>
                        </div>
                    `;
                }

                // å¦‚æœæ˜¯è¢«ä¿ç•™çš„å±•å¼€é¡¹ï¼Œæ˜¾ç¤ºç‰¹æ®Šæ ·å¼
                const rankDisplay = isKeptForExpanded ? '-' : (index + 1);
                const itemStyle = isKeptForExpanded ? 'opacity: 0.7; border-top: 1px dashed rgba(255,255,255,0.2); margin-top: 8px; padding-top: 8px;' : '';

                return `
                    <li class="leaderboard-item" data-civ-number="${h.number}" style="${itemStyle}" onclick="toggleLeaderboardDetails(${h.number})">
                        <span class="leaderboard-rank ${rankClass}">${rankDisplay}</span>
                        <span class="leaderboard-civ">ç¬¬ ${h.number} å·æ–‡æ˜</span>
                        <span class="leaderboard-duration">${formatDuration(h.duration)}</span>
                    </li>
                    ${detailsHtml}
                `;
            }).join('');

            // æ¢å¤ä¹‹å‰å±•å¼€çš„è¯¦æƒ…ï¼ˆä½¿ç”¨æ–‡æ˜ç¼–å·ï¼‰
            if (currentExpandedCivNumber >= 0) {
                const detailsEl = document.getElementById('details-civ-' + currentExpandedCivNumber);
                if (detailsEl) {
                    detailsEl.classList.add('show');
                }
            }
        }

        function toggleLeaderboardDetails(civNumber) {
            const detailsEl = document.getElementById('details-civ-' + civNumber);
            if (detailsEl) {
                // å…³é—­å…¶ä»–å±•å¼€çš„è¯¦æƒ…
                document.querySelectorAll('.leaderboard-details').forEach(el => {
                    if (el.id !== 'details-civ-' + civNumber) {
                        el.classList.remove('show');
                    }
                });
                // åˆ‡æ¢å½“å‰è¯¦æƒ…
                const isShowing = detailsEl.classList.toggle('show');
                // è®°å½•å½“å‰å±•å¼€çš„æ–‡æ˜ç¼–å·
                currentExpandedCivNumber = isShowing ? civNumber : -1;
            }
        }

        function formatDuration(years) {
            if (years < 1) return '< 1 å¹´';
            if (years < 1000) return Math.floor(years) + ' å¹´';
            if (years < 1000000) return (years / 1000).toFixed(1) + ' åƒå¹´';
            if (years < 1000000000) return (years / 1000000).toFixed(2) + ' ç™¾ä¸‡å¹´';
            return (years / 1000000000).toFixed(2) + ' åäº¿å¹´';
        }

        function showNotification(message) {
            const notif = document.getElementById('notification');
            notif.textContent = message;
            notif.classList.add('show');
            setTimeout(() => notif.classList.remove('show'), 3000);
        }

        // ==================== æ§åˆ¶å‡½æ•° ====================
        function togglePause() {
            paused = !paused;
            document.getElementById('btn-pause').textContent = paused ? 'ç»§ç»­' : 'æš‚åœ';
        }

        function updateSpeed() {
            const slider = document.getElementById('speed-slider');
            const value = parseFloat(slider.value);
            speedMultiplier = Math.pow(10, value / 25);
            document.getElementById('speed-value').textContent = speedMultiplier.toFixed(speedMultiplier < 10 ? 1 : 0) + 'x';
        }

        function setSpeed(speed) {
            speedMultiplier = speed;
            document.getElementById('speed-value').textContent = speed + 'x';
            const sliderValue = Math.log10(speed) * 25;
            document.getElementById('speed-slider').value = Math.min(100, Math.max(0, sliderValue));
        }

        function toggleTrails() {
            showTrails = document.getElementById('show-trails').checked;
            if (!showTrails) {
                stars.forEach(s => s.clearTrail());
                planet.clearTrail();
            }
        }

        function resetSimulation() {
            simulationTime = 0;
            civilizationNumber = 1;
            history = [];
            document.getElementById('civ-number').textContent = '1';
            updateHistoryDisplay();
            updateLeaderboard();  // åŒæ—¶æ›´æ–°æ’è¡Œæ¦œ
            initBodies();
            resetView();
            showNotification('æ¨¡æ‹Ÿå·²é‡ç½® - æ–°çš„åˆå§‹æ¡ä»¶');
        }

        // ==================== æ¸²æŸ“å‡½æ•° (3D) ====================
        function render() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // è®¡ç®—è´¨å¿ƒ
            let comX = 0, comY = 0, comZ = 0, totalMass = 0;
            for (const star of stars) {
                comX += star.x * star.mass;
                comY += star.y * star.mass;
                comZ += star.z * star.mass;
                totalMass += star.mass;
            }
            comX /= totalMass;
            comY /= totalMass;
            comZ /= totalMass;

            // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
            let maxDist = 0;
            for (const star of stars) {
                const dist = Math.sqrt(
                    Math.pow(star.x - comX, 2) +
                    Math.pow(star.y - comY, 2) +
                    Math.pow(star.z - comZ, 2)
                );
                maxDist = Math.max(maxDist, dist);
            }
            const planetDist = Math.sqrt(
                Math.pow(planet.x - comX, 2) +
                Math.pow(planet.y - comY, 2) +
                Math.pow(planet.z - comZ, 2)
            );
            maxDist = Math.max(maxDist, planetDist);

            const padding = 2.0;
            const baseScale = Math.min(canvas.width, canvas.height) / (maxDist * padding * 2) || 1e-10;

            const centerX = canvas.width / 2;
            const centerY = canvas.height / 2;

            // æ”¶é›†æ‰€æœ‰è¦ç»˜åˆ¶çš„å¯¹è±¡å¹¶æŒ‰ Z æ’åºï¼ˆç”»å®¶ç®—æ³•ï¼‰
            const drawObjects = [];

            // æ·»åŠ æ’æ˜Ÿ
            for (const star of stars) {
                const proj = project3D(star.x - comX, star.y - comY, star.z - comZ, centerX, centerY, baseScale);
                drawObjects.push({
                    type: 'star',
                    obj: star,
                    proj: proj,
                    comX, comY, comZ, baseScale
                });
            }

            // æ·»åŠ è¡Œæ˜Ÿ
            const planetProj = project3D(planet.x - comX, planet.y - comY, planet.z - comZ, centerX, centerY, baseScale);
            drawObjects.push({
                type: 'planet',
                obj: planet,
                proj: planetProj,
                comX, comY, comZ, baseScale
            });

            // æŒ‰ Z æ·±åº¦æ’åºï¼ˆè¿œçš„å…ˆç”»ï¼‰
            drawObjects.sort((a, b) => b.proj.z - a.proj.z);

            // å…ˆç»˜åˆ¶è½¨è¿¹
            if (showTrails) {
                // æ’æ˜Ÿè½¨è¿¹
                for (const star of stars) {
                    if (star.trail.length > 1) {
                        ctx.beginPath();
                        const first = project3D(star.trail[0].x - comX, star.trail[0].y - comY, star.trail[0].z - comZ, centerX, centerY, baseScale);
                        ctx.moveTo(first.x, first.y);
                        for (let i = 1; i < star.trail.length; i++) {
                            const p = project3D(star.trail[i].x - comX, star.trail[i].y - comY, star.trail[i].z - comZ, centerX, centerY, baseScale);
                            ctx.lineTo(p.x, p.y);
                        }
                        ctx.strokeStyle = star.color + '50';
                        ctx.lineWidth = 1.5;
                        ctx.stroke();
                    }
                }

                // è¡Œæ˜Ÿè½¨è¿¹
                if (planet.trail.length > 1) {
                    ctx.beginPath();
                    const first = project3D(planet.trail[0].x - comX, planet.trail[0].y - comY, planet.trail[0].z - comZ, centerX, centerY, baseScale);
                    ctx.moveTo(first.x, first.y);
                    for (let i = 1; i < planet.trail.length; i++) {
                        const p = project3D(planet.trail[i].x - comX, planet.trail[i].y - comY, planet.trail[i].z - comZ, centerX, centerY, baseScale);
                        ctx.lineTo(p.x, p.y);
                    }
                    ctx.strokeStyle = '#1dd1a150';
                    ctx.lineWidth = 1;
                    ctx.stroke();
                }
            }

            // ç»˜åˆ¶å¤©ä½“
            for (const item of drawObjects) {
                const { proj } = item;

                if (item.type === 'star') {
                    const star = item.obj;
                    const visualRadius = (Math.pow(star.mass / M_SUN, 0.3) * 15 + 8) * proj.scale;

                    // å‘å…‰æ•ˆæœ
                    const gradient = ctx.createRadialGradient(proj.x, proj.y, 0, proj.x, proj.y, visualRadius * 4);
                    gradient.addColorStop(0, star.color);
                    gradient.addColorStop(0.2, star.color + 'cc');
                    gradient.addColorStop(0.5, star.color + '40');
                    gradient.addColorStop(1, 'transparent');
                    ctx.fillStyle = gradient;
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, visualRadius * 4, 0, Math.PI * 2);
                    ctx.fill();

                    // æ’æ˜Ÿæœ¬ä½“
                    ctx.fillStyle = star.color;
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, visualRadius, 0, Math.PI * 2);
                    ctx.fill();

                    // é«˜å…‰
                    ctx.fillStyle = 'rgba(255,255,255,0.4)';
                    ctx.beginPath();
                    ctx.arc(proj.x - visualRadius * 0.3, proj.y - visualRadius * 0.3, visualRadius * 0.3, 0, Math.PI * 2);
                    ctx.fill();

                    // åç§°
                    ctx.fillStyle = star.color;
                    ctx.font = 'bold 14px "Microsoft YaHei"';
                    ctx.fillText(star.name, proj.x + visualRadius + 5, proj.y + 5);

                } else if (item.type === 'planet') {
                    const planetVisualRadius = 6 * proj.scale;

                    // è¡Œæ˜Ÿå‘å…‰
                    const planetGradient = ctx.createRadialGradient(proj.x, proj.y, 0, proj.x, proj.y, planetVisualRadius * 3);
                    planetGradient.addColorStop(0, '#1dd1a1');
                    planetGradient.addColorStop(0.5, '#1dd1a180');
                    planetGradient.addColorStop(1, 'transparent');
                    ctx.fillStyle = planetGradient;
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, planetVisualRadius * 3, 0, Math.PI * 2);
                    ctx.fill();

                    // è¡Œæ˜Ÿæœ¬ä½“
                    ctx.fillStyle = '#1dd1a1';
                    ctx.beginPath();
                    ctx.arc(proj.x, proj.y, planetVisualRadius, 0, Math.PI * 2);
                    ctx.fill();

                    // è¡Œæ˜Ÿåç§°
                    ctx.fillStyle = '#1dd1a1';
                    ctx.font = '12px "Microsoft YaHei"';
                    ctx.fillText('ä¸‰ä½“è¡Œæ˜Ÿ', proj.x + 10, proj.y - 10);
                }
            }

            // ç»˜åˆ¶åæ ‡è½´æŒ‡ç¤º
            const axisLength = 50;
            const axisOrigin = { x: 80, y: canvas.height - 80 };

            const xAxis = project3D(axisLength * AU, 0, 0, 0, 0, baseScale);
            const yAxis = project3D(0, axisLength * AU, 0, 0, 0, baseScale);
            const zAxis = project3D(0, 0, axisLength * AU, 0, 0, baseScale);

            // X è½´ (çº¢)
            ctx.beginPath();
            ctx.moveTo(axisOrigin.x, axisOrigin.y);
            ctx.lineTo(axisOrigin.x + xAxis.x * 0.01, axisOrigin.y + xAxis.y * 0.01);
            ctx.strokeStyle = '#ff6b6b';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = '#ff6b6b';
            ctx.fillText('X', axisOrigin.x + xAxis.x * 0.012, axisOrigin.y + xAxis.y * 0.012);

            // Y è½´ (ç»¿)
            ctx.beginPath();
            ctx.moveTo(axisOrigin.x, axisOrigin.y);
            ctx.lineTo(axisOrigin.x + yAxis.x * 0.01, axisOrigin.y + yAxis.y * 0.01);
            ctx.strokeStyle = '#1dd1a1';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = '#1dd1a1';
            ctx.fillText('Y', axisOrigin.x + yAxis.x * 0.012, axisOrigin.y + yAxis.y * 0.012);

            // Z è½´ (è“)
            ctx.beginPath();
            ctx.moveTo(axisOrigin.x, axisOrigin.y);
            ctx.lineTo(axisOrigin.x + zAxis.x * 0.01, axisOrigin.y + zAxis.y * 0.01);
            ctx.strokeStyle = '#48dbfb';
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.fillStyle = '#48dbfb';
            ctx.fillText('Z', axisOrigin.x + zAxis.x * 0.012, axisOrigin.y + zAxis.y * 0.012);

            // ç»˜åˆ¶æ¯”ä¾‹å°º
            ctx.strokeStyle = 'rgba(255,255,255,0.4)';
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.moveTo(20, canvas.height - 30);
            ctx.lineTo(120, canvas.height - 30);
            ctx.stroke();

            ctx.fillStyle = 'rgba(255,255,255,0.6)';
            ctx.font = '12px Consolas';
            const scaleAU = (100 / (baseScale * cameraZoom * AU)).toFixed(1);
            ctx.fillText(`${scaleAU} AU`, 20, canvas.height - 40);
        }

        // ==================== ä¸»å¾ªç¯ ====================
        let lastTime = performance.now();
        const BASE_DT = 3600 * 24;

        function simulate() {
            const currentTime = performance.now();
            const realDt = (currentTime - lastTime) / 1000;
            lastTime = currentTime;

            if (!paused && realDt < 1) {
                const simDt = BASE_DT * speedMultiplier * Math.min(realDt * 60, 1);
                const substeps = Math.max(1, Math.ceil(speedMultiplier / 10));
                const subDt = simDt / substeps;

                for (let i = 0; i < substeps; i++) {
                    const allBodies = [...stars, planet];
                    rk4Step(allBodies, subDt);
                    simulationTime += subDt;
                }

                if (showTrails) {
                    stars.forEach(s => s.addTrailPoint());
                    planet.addTrailPoint();
                }

                checkCivilization();

                const durationSeconds = simulationTime - civilizationStartTime;
                const years = durationSeconds / (365.25 * 24 * 3600);
                document.getElementById('duration').textContent = formatDuration(years);
            }

            render();
            requestAnimationFrame(simulate);
        }

        // ==================== å¯åŠ¨ ====================
        initBodies();
        updateSpeed();
        simulate();

        // ==================== ä¾§è¾¹æ æ‹–æ‹½è°ƒæ•´å®½åº¦ ====================
        const resizeHandle = document.getElementById('resize-handle');
        const sidebar = document.getElementById('sidebar');
        let isResizing = false;

        resizeHandle.addEventListener('mousedown', (e) => {
            isResizing = true;
            resizeHandle.classList.add('dragging');
            document.body.style.cursor = 'ew-resize';
            document.body.style.userSelect = 'none';
            e.preventDefault();
        });

        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;

            const newWidth = window.innerWidth - e.clientX;
            const clampedWidth = Math.min(800, Math.max(300, newWidth));
            sidebar.style.width = clampedWidth + 'px';

            resizeCanvas();
        });

        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                resizeHandle.classList.remove('dragging');
                document.body.style.cursor = '';
                document.body.style.userSelect = '';
            }
        });
    </script>
</body>
</html>
